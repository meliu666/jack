#bash <(curl -fsSL https://raw.githubusercontent.com/meliu666/scripts/main/ssgo.sh)

#!/bin/bash
set -e

# 变量设置
PORT=22222
PASSWORD="jackpassword"
CIPHER="chacha20-ietf-poly1305"
INSTALL_DIR="/usr/bin/shadowsocks-go"
BIN="$INSTALL_DIR/shadowsocks-go"
SERVICE_FILE="/lib/systemd/system/shadowsocks-go.service"
TMP_DIR="/tmp/ss-tmp"
VER=$(curl -s https://api.github.com/repos/shadowsocks/go-shadowsocks2/releases | grep -m1 'tag_name' | cut -d\" -f4)

# 安装必要工具
apt-get update -y
apt-get install -y wget gzip curl

# 下载 Shadowsocks-Go
mkdir -p "$INSTALL_DIR" "$TMP_DIR"
wget -O "$TMP_DIR/shadowsocks2-linux.gz" "https://github.com/shadowsocks/go-shadowsocks2/releases/download/${VER}/shadowsocks2-linux.gz"
gzip -df "$TMP_DIR/shadowsocks2-linux.gz"
mv "$TMP_DIR/shadowsocks2-linux" "$BIN"
chmod +x "$BIN"

# 创建 systemd 服务文件
cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=Shadowsocks-Go Service
After=network.target
Wants=network.target

[Service]
Type=simple
ExecStart=$BIN -s "ss://${CIPHER}:${PASSWORD}@:${PORT}"
RestartSec=3
Restart=always
LimitNOFILE=1048576
LimitNPROC=512

[Install]
WantedBy=multi-user.target
EOF

# 启用服务
systemctl daemon-reexec
systemctl enable shadowsocks-go
systemctl restart shadowsocks-go

# 开放端口（IPv4 和 IPv6）
iptables -I INPUT -p tcp --dport $PORT -j ACCEPT
iptables -I INPUT -p udp --dport $PORT -j ACCEPT
ip6tables -I INPUT -p tcp --dport $PORT -j ACCEPT
ip6tables -I INPUT -p udp --dport $PORT -j ACCEPT

# 开启 BBR（如果内核支持）
if [[ $(uname -r | cut -d. -f1) -ge 5 ]] || [[ $(uname -r | cut -d. -f1) -eq 4 && $(uname -r | cut -d. -f2) -ge 9 ]]; then
  echo "net.core.default_qdisc = fq" >> /etc/sysctl.conf
  echo "net.ipv4.tcp_congestion_control = bbr" >> /etc/sysctl.conf
  sysctl -p
fi
